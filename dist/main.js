/*! @keithclark/diskview v1.0.0 - Keith Clark (https://keithclark.co.uk) - MIT license */
const t="WriteError";class e extends Error{#t;constructor(t,e,r){super(t,r),this.#t=e}get name(){return this.#t}}const r=32,s=/^[A-Z0-9$%'\-_@~`!()^#&]{1,8}(\.[A-Z0-9$%'\-_@~`!()^#&]{1,3})?$/,i=t=>{t.startsWith("/")||(t="/"+t);const e=t.split("/").slice(1).filter(t=>!!t),r=e.at(-1)??"",[s,i=""]=r.split(".");return{segments:e,dir:`/${e.slice(0,-1).join("/")}`,base:r,name:s,ext:i}},n=t=>s.test(t);class a{#e;constructor(t,e=0){if(!(t instanceof ArrayBuffer))throw"Expected ArrayBuffer";this.#e=new DataView(t,e,this.byteLength)}#r(t){if(!n(t))throw new e(`Invalid filename "${t}"`)}getName(){const t=new TextDecoder,{buffer:e,byteOffset:r}=this.#e,s=t.decode(new Uint8Array(e,r,11)),i=s.slice(0,8).trim(),n=s.slice(8).trim();return n?`${i}.${n}`:i}setName(t){this.#r(t);const{buffer:e,byteOffset:r}=this.#e,{name:s,ext:n}=i(t),a=s.padEnd(8," ")+n.padEnd(3," ");new Uint8Array(e,r,11).set((new TextEncoder).encode(a.toUpperCase()))}getStartCluster(){return this.#e.getUint16(26,!0)}setStartCluster(t){this.#e.setUint16(26,t,!0)}getAttributes(){return this.#e.getUint8(11)}setAttributes(t){return this.#e.setUint8(11,t)}getSize(){return this.#e.getUint32(28,!0)}setSize(t){this.#e.setUint32(28,t,!0)}get buffer(){return this.#e.buffer}get byteOffset(){return this.#e.byteOffset}get byteLength(){return r}}class o{#e;constructor(t,e=0,r=t.byteLength){this.#e=new Uint8Array(t,e,r)}getCluster(t){const e=Math.floor(1.5*t),r=1&t,s=this.#e[e],i=this.#e[e+1];return r?4095&(i<<4|s>>4):(15&i)<<8|s}setCluster(t,e){const r=Math.floor(1.5*t);if(e&=4095,1&t){const t=this.#e[r];this.#e[r]=15&t|(15&e)<<4,this.#e[r+1]=e>>4&255}else{this.#e[r]=255&e;const t=this.#e[r+1];this.#e[r+1]=240&t|e>>8&15}}getClusterChain(t){const e=[];for(;t<4088;)e.push(t),t=this.getCluster(t);return e}get buffer(){return this.#e.buffer}get byteOffset(){return this.#e.byteOffset}get byteLength(){return this.#e.byteLength}}class h{#s;#i;#n;#a;#o;#h;constructor(t,e=80,r=2,s=9,i=512){if(!(t instanceof ArrayBuffer))throw new TypeError(`Expected ArrayBuffer. Got ${t.constructor.name}.`);this.#s=t,this.#i=e,this.#n=r,this.#a=s,this.#o=i,this.#h=s*i}#c(t,e,r){if(t<1||t>this.#a)throw new RangeError(`Sector out of bounds. Expected 1-${this.#a}. Got ${t}.`);if(e<0||e>this.#i-1)throw new RangeError(`Track out of bounds. Expected 0-${this.#i-1}. Got ${this.#i}.`);if(r<0||e>this.#n-1)throw new RangeError(`Side out of bounds. Expected 0-${this.#n-1}. Got ${this.#n}.`);let s=e*this.#n*this.#h;return s+=r*this.#h,s+=(t-1)*this.#o,s}getTrack(t,e=0){const r=this.#c(1,t,e),s=r+this.#h;return Uint8Array(this.#s.slice(r,s))}getSector(t,e=0,r=0){const s=this.#c(t,e,r),i=s+this.#o;return new Uint8Array(this.#s.slice(s,i))}setSector(t,e=0,r=0,s){if(s.length!==this.#o)throw new RangeError(`Buffer length invalid. Expected ${this.#o} bytes, got ${s.length}.`);const i=this.#c(t,e,r);new Uint8Array(this.#s).set(s,i)}get buffer(){return this.#s}get bytesPerSector(){return this.#o}get tracks(){return this.#i}get sides(){return this.#n}}class c extends h{#u;#l;#f;#g;#y;#b;#w;#d;#S;#C;constructor(t){const e=new DataView(t),s=e.getUint16(11,!0),i=e.getUint8(13),n=e.getUint16(19,!0),a=e.getUint16(24,!0),o=e.getUint16(26,!0);super(t,n/a/o,o,a,s),this.#C=e.getUint16(17,!0),this.#S=e.getUint16(14,!0)||1,this.#d=e.getUint8(16),this.#w=e.getUint16(22,!0),this.#g=i*s,this.#u=this.#S*this.bytesPerSector,this.#l=this.#u+this.#d*this.#w*this.bytesPerSector,this.#f=this.#C*r,this.#y=this.#l+this.#f;const h=this.#d*this.#w,c=n-this.#S-h-this.#f/s;this.#b=c/i}#E(t){const{dir:e,base:r}=i(t);return{name:r,directory:this.getDirectoryAtPath(e)}}*#m(){yield*this.#v(this.#l,this.#f)}*#v(t,e){const s=new Uint8Array(this.buffer,t,e);let i=0;for(;i<e&&0!==s[i];)yield new a(this.buffer,t+i),i+=r}*#D(t){const e=this.#z().getClusterChain(t.getStartCluster());for(let t of e){const e=this.#y+(t-2)*this.#g;yield*this.#v(e,this.#g)}}#A(t){return t?this.#D(t):this.#m()}#P(t,e){for(const r of t)if(r.getName()===e)return r;return null}#r(t){if(!n(t))throw new e(`Invalid filename "${t}"`)}#U(r,s){if(this.#P(r,s))throw new e(`"${s}" aleady exists`,t)}getFree(){const t=this.#z();let e=0;for(let r=2;r<this.#b;r++)0===t.getCluster(r)&&(e+=this.#g);return e}getSize(){return this.#b*this.#g}#F(t,r=null){this.#r(t);const s=this.#A(r),i=this.#P(s,t);if(!i)throw new e(`Entry "${t}" not found"`,"NotFoundError");return i}#T(t,e=0,s=null){const i=this.getDirectoryEntries(s);this.#r(t),this.#U(i,t);const n=this.#x(),o=i.at(-1).byteOffset+r,h=new a(this.buffer,o);return h.setName(t),h.setSize(0),h.setAttributes(e),h.setStartCluster(n),this.#$(n,4095),h}getFile(t,r=null){const s=this.#F(t,r);if(16&s.getAttributes())throw new e(`${t} is not a file`);return s}createFile(t,e=null){return this.#T(t,0,e)}getFileContents(t){const e=this.#z().getClusterChain(t.getStartCluster()),r=new Uint8Array(this.#g*e.length);return e.forEach((t,e)=>{const s=this.#p(t);r.set(new Uint8Array(s),this.#g*e)}),r.slice(0,t.getSize())}setFileContents(t,e){"string"==typeof e&&(e=(new TextEncoder).encode(e));const r=this.#z(),s=Math.ceil(e.byteLength/this.#g),i=r.getClusterChain(t.getStartCluster()),n=i.slice(s),a=i.slice(0,s),o=[];try{for(;a.length<s;){const t=this.#x();o.push(t),a.push(t)}}catch(t){for(const t of o)this.#k(t);throw t}a.forEach((t,r)=>{const s=r*this.#g,i=e.slice(s,s+this.#g);this.#N(t,i);const n=a[r+1];n?this.#$(t,n):this.#$(t,4095)}),t.setSize(e.byteLength),n.forEach(t=>{this.#k(t)})}getDirectory(t,r=null){const s=this.#F(t,r);if(!(16&s.getAttributes()))throw new e(`${t} is not a directory`);return s}getDirectoryEntries(t=null){return[...this.#A(t)]}createDirectory(t,e=null){const s=this.#T(t,16,e),i=new Uint8Array(64),n=s.getStartCluster(),o=e?.getStartCluster()??0,h=new a(i.buffer);h.setName("A"),h.setSize(0),h.setAttributes(16),h.setStartCluster(n);const c=new a(i.buffer,r);return c.setName("A"),c.setSize(0),c.setAttributes(16),c.setStartCluster(o),i[0]=46,i[32]=46,i[33]=46,this.#N(n,i),s}getFileAtPath(t){const{name:e,directory:r}=this.#E(t);return this.getFile(e,r)}createFileAtPath(t){const{name:e,directory:r}=this.#E(t);return this.createFile(e,r)}getDirectoryAtPath(t){const{segments:e}=i(t);let r=null;for(;e.length;){const t=e.shift();r=this.getDirectory(t,r)}return r}createDirectoryAtPath(t){const{name:e,directory:r}=this.#E(t);return this.createDirectory(e,r)}#p(t){const e=this.#y+(t-2)*this.#g;return this.buffer.slice(e,e+this.#g)}#N(t,e){const r=this.#y+(t-2)*this.#g;return new Uint8Array(this.buffer).set(e,r)}#x(r=0){const s=this.#z(r);for(let t=2;t<this.#b;t++)if(0===s.getCluster(t))return this.#$(t,1),t;throw new e("Disk full",t)}#k(t){this.#$(t,0)}#z(t=0){if(t<0||t>this.#d-1)throw new Error("Invalid FAT number.");const e=this.#w*this.bytesPerSector;return new o(this.buffer,this.#u+t*e,e)}#$(t,e){for(let r=0;r<this.#d;r++){this.#z(r).setCluster(t,e)}}}export{a as Fat12DirectoryEntryView,c as default};
